---
title: "Quality Control"
date: "`r BiocStyle::doc_date()`"
package: sesame
output: BiocStyle::html_document
fig_width: 6
fig_height: 5
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{1. Quality Control}
  %\VignetteEncoding{UTF-8}
---

```{r message=FALSE, results="hide"}
library(sesame)
sesameDataCache()
```

# Calculate Quality Metrics

The main function to calculate the quality metrics is `sesameQC_calcStats`.
SeSAMe divides sample quality metrics into multiple groups. Each group of
quality metrics can be generated using a dedicated function. All these
functions can be accessed through the `sesameQC_calcStats`
function. `sesameQC_calcStats()` takes a SigDF, calculates the QC statistics
and returns a single object of the class `sesameQC` which can be printed
directly to the console.

```{r qc1, message=FALSE}
sdf <- sesameDataGet('EPIC.1.SigDF')
qc <- sesameQC_calcStats(sdf, c("dyeBias", "detection"))
qc
```

The `sesameQC_calcStats` function returns an S4 `sesameQC` object. The choice
of QC metrics depends on the 2nd argument of the `sesameQC_calcStats`
function. This argument is optional and can take one or a list of the following
keys.

```{r echo=FALSE}
library(knitr)
kable(data.frame(
    "Short Key" = c(
        "detection",
        "numProbes",
        "intensity",
        "channel",
        "dyeBias",
        "betas"),
    "Description" = c(
        "Signal Detection",
        "Number of Probes",
        "Signal Intensity",
        "Color Channel",
        "Dye Bias",
        "Beta Value")))
```

For example, "intensity" generates signal intensity related quality
metrics. When the 2nd argument is not given, all stats will be calculated. We
consider signal detection the most important QC metric.  One can retrieve the
actual stat numbers from `sesameQC` using the sesameQC_getStats:

```{r qc2}
sesameQC_getStats(qc, "frac_dt")
```

One can combine multiple sesameQC into a data frame:

```{r eval=FALSE}
sdfs <- sesameDataGet("EPIC.5.SigDF.normal")
df <- do.call(rbind, lapply(sdfs, function(sdf)
   as.data.frame(sesameQC_calcStats(sdf, "detection"))))
```

# Rank Quality Metrics

```{r qc4, echo=FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)
```

SeSAMe features comparison of your sample with public data sets. The
`sesameQC_rankStats()` function ranks the input `sesameQC` object with
`sesameQC` calculated from public datasets. It shows the rank percentage of the
input sample as well as the number of datasets compared.

```{r qc5}
sdf <- sesameDataGet('EPIC.1.SigDF')
qc <- sesameQC_calcStats(sdf, "intensity")
qc
sesameQC_rankStats(qc, platform="EPIC")
```

# Quality Control Plots

SeSAMe provides functions to create QC plots. Some functions takes sesameQC as
input while others directly plot the SigDF objects. Here are some examples:

- `sesameQC_plotBar()` takes a list of sesameQC objects and creates bar
plot for each metric calculated.

- `sesameQC_plotRedGrnQQ()` graphs the dye bias between the two color channels.

- `sesameQC_plotIntensVsBetas()` plots the relationship between $\beta$ values and signal intensity and can be used to diagnose artificial readout and influence of signal background.

- `sesameQC_plotHeatSNPs()` plots SNP probes and can be used to detect sample swaps.

More about quality control plots can be found in [Supplemental
Vignette](https://zhou-lab.github.io/sesame/supplemental.html#Quality_control_plots).

# Session Info

```{r}
sessionInfo()
```